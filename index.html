<!doctype html>
<html lang="sk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Synchronized MP3 player — STRICT sync only</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;margin:24px;color:#111}
    .card{max-width:720px;padding:18px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.06)}
    label,select,button{display:block;margin:8px 0}
    #status{margin-top:12px;font-size:0.95rem;color:#333}
    .controls{margin-top:10px}
    button{padding:10px 14px;border-radius:8px;border:1px solid #ddd;background:#fafafa;cursor:pointer}
    /* Skryjeme audio UI úplne */
    audio{display:none !important}
  </style>
</head>
<body>
  <div class="card">
    <h2>Synchronized MP3 player — iba synchronizované prehrávanie</h2>
    <p>Na tejto strane je možné prehrávať zvuk <strongvýhradne</strong> synchronizovane. Je tu len jedno tlačidlo <em>Pustiť (synchronizovane)</em>. Ak sa niekto pokúsi preskočiť alebo spustiť zvuk iným spôsobom, prehrávanie sa okamžite vráti na správne synchronizované miesto.</p>

    <label for="person">Meno:</label>
    <select id="person" aria-label="Vyberte meno"></select>

    <div class="controls">
      <button id="playBtn">Pustiť (synchronizovane)</button>
    </div>

    <div id="status">Stav: pripravený</div>

    <audio id="player" preload="metadata"></audio>

    <hr />
    <p style="font-size:0.9rem;color:#555">Konfigurácia v kóde: objekt <code>tracks</code> (mapovanie meno → cesta k mp3) a <code>referenceTime</code> ("HH:MM").</p>
  </div>

<script>
// ---------- KONFIGURÁCIA (upraviť v kóde) ----------
const tracks = {
  "Adam": "audio/test.mp3",
  "Eva":  "audio/test.mp3"
};
const referenceTime = "01:30"; // format "HH:MM"
const RESYNC_INTERVAL_MS = 3000; // kontrola každé 3s
const RESYNC_TOLERANCE_S = 0.4;  // ak rozdiel väčší než 0.4s, prepíše sa
// ---------- KONIEC KONFIGURÁCIE ----------

const selectEl = document.getElementById('person');
const playBtn = document.getElementById('playBtn');
const statusEl = document.getElementById('status');
const audio = document.getElementById('player');

let currentBlobUrl = null;
let resyncTimer = null;
let syncRequested = false; // príznak, že play bol iniciovaný naším sync flow
let playPendingTimeout = null;

function setStatus(txt){ statusEl.textContent = 'Stav: ' + txt; }

// naplni select
function populateSelect(){
  Object.keys(tracks).forEach(name => {
    const opt = document.createElement('option'); opt.value = name; opt.textContent = name; selectEl.appendChild(opt);
  });
}

function parseReference(){
  const [hh, mm] = (referenceTime || '00:00').split(':').map(Number);
  const ref = new Date(); ref.setHours(hh, mm || 0, 0, 0); return ref.getTime();
}

async function fetchAndCacheIfNeeded(name){
  const url = tracks[name];
  if(!url) throw new Error('Neznáme meno');
  // skúsime cache
  if('caches' in window){
    const cache = await caches.open('synchronized-mp3-cache-v1');
    const matched = await cache.match(new Request(url));
    if(matched) return matched;
  }
  // ak nie v cache, stiahneme a uložíme
  const resp = await fetch(new Request(url, {mode:'cors'}));
  if(!resp.ok) throw new Error('Chyba pri sťahovaní: ' + resp.status);
  if('caches' in window){
    const cache = await caches.open('synchronized-mp3-cache-v1');
    await cache.put(new Request(url), resp.clone());
    return resp.clone();
  }
  return resp;
}

async function setAudioFromResponse(response){
  const blob = await response.blob();
  if(currentBlobUrl){ URL.revokeObjectURL(currentBlobUrl); currentBlobUrl = null; }
  currentBlobUrl = URL.createObjectURL(blob);
  audio.src = currentBlobUrl;
}

function computeDesiredPosition(){
  if(!audio.duration || !isFinite(audio.duration)) return 0;
  const now = Date.now(); const ref = parseReference();
  const offset = (now - ref) / 1000;
  if(offset < 0) return 0;
  return ((offset % audio.duration) + audio.duration) % audio.duration;
}

async function playSynchronized(){
  const name = selectEl.value; if(!name) { setStatus('vyberte meno'); return; }
  setStatus('pripravujem...');

  try{
    const resp = await fetchAndCacheIfNeeded(name);
    await setAudioFromResponse(resp);
  }catch(err){ console.error(err); setStatus('Chyba pri načítaní'); return; }

  // čakáme na metadata
  await new Promise(resolve => {
    if(!isFinite(audio.duration)){
      audio.addEventListener('loadedmetadata', function onm(){ audio.removeEventListener('loadedmetadata', onm); resolve(); });
    } else resolve();
  });

  const now = Date.now(); const ref = parseReference();
  const msToRef = ref - now;

  // ak pred referenčným časom: nastavíme currentTime=0 a počkáme
  if(msToRef > 0){
    audio.currentTime = 0; audio.pause(); setStatus('čeká sa na referenčný čas');
    clearTimeout(playPendingTimeout);
    playPendingTimeout = setTimeout(async ()=>{
      syncRequested = true;
      try{ await audio.play(); setStatus('hrá (synchronizované)'); startResyncLoop(); }catch(e){ setStatus('play blokovaný'); }
    }, msToRef);
    return;
  }

  // ak po referenčnom čase
  const desired = computeDesiredPosition();
  audio.currentTime = desired;
  syncRequested = true;
  try{ await audio.play(); setStatus('hrá (synchronizované)'); startResyncLoop(); }
  catch(e){ setStatus('play blokovaný'); }
}

function startResyncLoop(){
  if(resyncTimer) clearInterval(resyncTimer);
  resyncTimer = setInterval(()=>{
    if(audio.paused) return;
    const desired = computeDesiredPosition();
    if(Math.abs(audio.currentTime - desired) > RESYNC_TOLERANCE_S){
      audio.currentTime = desired;
    }
  }, RESYNC_INTERVAL_MS);
}

function stopPlaybackCleanup(){
  syncRequested = false;
  if(resyncTimer) { clearInterval(resyncTimer); resyncTimer = null; }
  if(playPendingTimeout) { clearTimeout(playPendingTimeout); playPendingTimeout = null; }
}

// STRIKTNE: zabráňte akejkoľvek forme manuálneho preskakovania alebo spustenia
audio.addEventListener('seeking', (e) => {
  const desired = computeDesiredPosition();
  if(Math.abs(audio.currentTime - desired) > 0.05){ audio.currentTime = desired; }
});

audio.addEventListener('timeupdate', ()=>{
  if(audio.paused) return;
  const desired = computeDesiredPosition();
  if(Math.abs(audio.currentTime - desired) > RESYNC_TOLERANCE_S){ audio.currentTime = desired; }
});

audio.addEventListener('play', ()=>{
  if(!syncRequested){
    // ak sa prehrávanie spustilo inak, ihneď ho preruš a začni sync flow
    audio.pause(); stopPlaybackCleanup(); playSynchronized();
  } else {
    // play bol autorizovaný sync flow -> po krátkej dobe resetujeme príznak
    setTimeout(()=>{ syncRequested = false; }, 100);
  }
});

// Zakážeme kontextové menu (pravé tlačidlo) a bežné klávesy ktoré by mohli spustiť/presunúť prehrávanie
window.addEventListener('contextmenu', e => e.preventDefault());
window.addEventListener('keydown', e => {
  // space (32), left(37), up(38), right(39), down(40), k(75) atď. — zablokujeme ich ak nie je focus v input
  const blocked = [32,37,38,39,40,75];
  const target = e.target;
  const isInput = target && (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable);
  if(blocked.includes(e.keyCode) && !isInput){ e.preventDefault(); e.stopPropagation(); }
}, true);

// Ak používateľ klikne kdekoľvek, ak to vedie k neautorizovanému prehratiu, vrátime to späť (dodatočná bezpečnosť)
document.addEventListener('click', (e)=>{
  // žiadne akcie — len čisté monitorovanie
  if(audio.paused) return;
  const desired = computeDesiredPosition();
  if(Math.abs(audio.currentTime - desired) > 0.05) audio.currentTime = desired;
});

// UI event
playBtn.addEventListener('click', ()=>{ stopPlaybackCleanup(); playSynchronized(); });

// init
(async function init(){ populateSelect(); setStatus('pripravený'); })();

</script>
</body>
</html>
